# -----------------------------
# Stage 1: Build stage
# -----------------------------
FROM --platform=linux/amd64 ubuntu:22.04 AS build

ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl wget unzip git python3 python3-pip build-essential ca-certificates \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Amazon Corretto 17 x64 manually
RUN curl -L -o /tmp/corretto-17.tar.gz https://corretto.aws/downloads/latest/amazon-corretto-17-x64-linux-jdk.tar.gz \
    && mkdir -p /opt/java \
    && tar -xzf /tmp/corretto-17.tar.gz -C /opt/java \
    && rm /tmp/corretto-17.tar.gz

ENV JAVA_HOME=/opt/java/amazon-corretto-17.0.8.1-linux-x64
ENV PATH=$JAVA_HOME/bin:$PATH

# Install Node.js 20 LTS
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g npm@latest

# Verify versions
RUN java -version && node -v && npm -v

# Set working directory
WORKDIR /workspace

# Copy source code into container
COPY ./repo /workspace

# Install Gradle Wrapper (already in JHipster projects)
RUN ./gradlew --version

# Install Node dependencies and build frontend
RUN ./gradlew npmInstall
RUN ./gradlew npmBuild

# Build backend JAR/WAR
RUN ./gradlew bootWar -Pprod -Pwar

# -----------------------------
# Stage 2: Runtime stage
# -----------------------------
FROM --platform=linux/amd64 ubuntu:22.04 AS runtime

# Minimal runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates openjdk-17-jre-headless \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Set JAVA_HOME for runtime
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH=$JAVA_HOME/bin:$PATH

# Set working directory
WORKDIR /app

# Copy built WAR/JAR from build stage
COPY --from=build /workspace/build/libs/*.war ./app.war

# Expose port (adjust if your app uses different port)
EXPOSE 8080

# Run the app
ENTRYPOINT ["java","-jar","app.war"]
